var Transport=require("../transport"),parser=require("engine.io-parser"),debug=require("debug")("engine:polling");module.exports=Polling;function Polling(a){Transport.call(this,a)}Polling.prototype.__proto__=Transport.prototype;Polling.prototype.name="polling";Polling.prototype.onRequest=function(b){var a=b.res;if("GET"==b.method){this.onPollRequest(b,a)}else{if("POST"==b.method){this.onDataRequest(b,a)}else{a.writeHead(500);a.end()}}};Polling.prototype.onPollRequest=function(e,c){if(this.req){debug("request overlap");this.onError("overlap from client");c.writeHead(500);return}debug("setting request");this.req=e;this.res=c;var b=this;function a(){b.onError("poll connection closed prematurely")}function d(){e.removeListener("close",a);b.req=b.res=null}e.cleanup=d;e.on("close",a);this.writable=true;this.emit("drain");if(this.writable&&this.shouldClose){debug("triggering empty send to append close packet");this.send([{type:"noop"}])}};Polling.prototype.onDataRequest=function(g,f){if(this.dataReq){this.onError("data request overlap from client");f.writeHead(500);return}var b="application/octet-stream"==g.headers["content-type"];this.dataReq=g;this.dataRes=f;var e=b?new Buffer(0):"";var i=this;function c(){e=b?new Buffer(0):"";g.removeListener("data",d);g.removeListener("end",a);g.removeListener("close",h);i.dataReq=i.dataRes=null}function h(){c();i.onError("data request connection closed prematurely")}function d(k){var j;if(typeof k=="string"){e+=k;j=Buffer.byteLength(e)}else{e=Buffer.concat([e,k]);j=e.length}if(j>i.maxHttpBufferSize){e="";g.connection.destroy()}}function a(){i.onData(e);f.writeHead(200,i.headers(g,{"Content-Length":2,"Content-Type":"text/html"}));f.end("ok");c()}g.abort=c;g.on("close",h);g.on("data",d);g.on("end",a);if(!b){g.setEncoding("utf8")}};Polling.prototype.onData=function(b){debug('received "%s"',b);var a=this;var c=function(d){if("close"==d.type){debug("got xhr close packet");a.onClose();return false}a.onPacket(d)};parser.decodePayload(b,c)};Polling.prototype.send=function(b){if(this.shouldClose){debug("appending close packet to payload");b.push({type:"close"});this.shouldClose();this.shouldClose=null}var a=this;parser.encodePayload(b,this.supportsBinary,function(c){a.write(c)})};Polling.prototype.write=function(a){debug('writing "%s"',a);this.doWrite(a);this.req.cleanup();this.writable=false};Polling.prototype.doClose=function(a){debug("closing");if(this.dataReq){debug("aborting ongoing data request");this.dataReq.abort()}if(this.writable){debug("transport writable - closing right away");this.send([{type:"close"}]);a()}else{debug("transport not writable - buffering orderly close");this.shouldClose=a}};